{# 子ども用学習登録画面 #}

{% extends 'app/child/base.html' %}
{% load index %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/child/record.css' %}?v=6">
{% endblock %}

{% block content %}
<div class="top-row">
  <p class="today">{{ today|date:"n月j日(D)" }}</p>
</div>
{% if is_past %}
  <h2>この日のできたこと！</h2>
{% else %}
  <h2>今日のできたこと！</h2>
{% endif %}

    {% if daily_log %}
        <p class="edit-note">登録済みの内容を変更できます</p>
    {% endif %}

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
{#項目#}
<div class="content-box">
    <div class="items">
        {% if item_rows %}
            {% for row in item_rows %}
                <div class="item-row">
                    <span class="color-box {{ row.class }}"></span>

                    <label class="item-label">
                        <input
                            type="checkbox"
                            name="item_ids"
                            value="{{ row.item.id }}"
                            {% if row.item.id in checked_item_ids %}checked{% endif %}
                        >
                        <span class="item-name">{{ row.item.item_name }}</span>
                    </label>
                </div>   
            {% endfor %}
        {% else %}
            <span class="empty-message">
            まだ学習項目が登録されていません<br>
            おうちの人に登録してもらおう！
            </span>
        {% endif %}
    </div>
</div>
 
   
{# photo1 #}
<div class="upload-grid">
    <div class="upload-item">
        <input id="photo1" type="file" name="photo1_url" accept="image/*" class="upload-input">
        <label for="photo1" class="upload-plus">
            <span class="plus">＋</span>
            <span class="note">（写真は1枠につき1枚）</span>
        </label>

        <div id="upload_preview1" class="upload-preview">
            {% if daily_log and daily_log.photo1_url %}
                <img src="{{ daily_log.photo1_url.url }}" style="max-width:100%; border-radius:8px;">
            {% endif %}
        </div>

        {# 　写真の削除（ソフト削除） #}
        {% if daily_log and daily_log.photo1_url %}
        <label class="delete-check">
            <input type="checkbox" name="delete_photo1" value="1">
        </label>
        {% endif %}
    </div>

{# photo2 #}
    <div class="upload-item">
        <input id="photo2" type="file" name="photo2_url" accept="image/*" class="upload-input">
        <label for="photo2" class="upload-plus">
            <span class="plus">＋</span>
            <span class="note">（写真は1枠につき1枚）</span>
        </label>

        <div id="upload_preview2" class="upload-preview">
            {% if daily_log and daily_log.photo2_url %}
                <img src="{{ daily_log.photo2_url.url }}" style="max-width:100%; border-radius:8px;">
            {% endif %}
        </div>
        {# 写真の削除（ソフト削除） #}
        {% if daily_log and daily_log.photo2_url %}
        <label class="delete-check">
            <input type="checkbox" name="delete_photo2" value="1">
        </label>
        {% endif %}
    </div>
</div>
    {% if daily_log.photo1_url or daily_log.photo2_url  %}
        <p class="delete-help">
            登録した写真はチェックして［変更］で削除されます
        </p>
    {% else %}
        <p class="delete-help">
            写真は登録・変更したあとに消せます
        </p>
    {% endif %}


<div class="content-box">
    <div class="form-center">
        {{ form.child_comment }}
    </div>        
</div>
    {% if form.child_comment.errors %}
        <div class="field-error">
            {{ form.child_comment.errors.0|linebreaksbr }}
        </div>
    {% endif %}
    
    <button type="submit" class="btn">
        {% if daily_log %}
            変更
        {% else %}
            登録
        {% endif %}
    </button>
</form>


{% endblock %}

{% block extra_js %}
<script>
    function setupImagePreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const previewBox = document.getElementById(previewId);
        const plusLabel = input.nextElementSibling; // ＋ラベル

         // 　初期表示：既存画像があれば「＋」を隠してプレビューを表示
        const hasInitialImage = previewBox.querySelector("img");
        if (hasInitialImage) {
            previewBox.style.display = "block";
            plusLabel.style.display = "none";
            } else {
                previewBox.style.display = "none";
                plusLabel.style.display = "flex";
            }

        input.addEventListener("change", () => {
            const file = input.files[0];

        // 何も選ばれていない場合
            if (!file) {
                previewBox.innerHTML = "";
                previewBox.style.display = "none";   // ←追加
                plusLabel.style.display = "flex";
                return;
            }

        // 画像以外は無視
            if (!file.type.startsWith("image/")) {
                previewBox.innerHTML = "";
                return;
            }

        // imgタグを作る
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.style.maxWidth = "100%";
            img.style.borderRadius = "8px";

        // 前のプレビューを消してから追加
            previewBox.innerHTML = "";
            previewBox.appendChild(img);

            previewBox.style.display = "block";  
            plusLabel.style.display = "none";
        });
    }

    // photo1 / photo2 に適用
    setupImagePreview("photo1", "upload_preview1");
    setupImagePreview("photo2", "upload_preview2");
</script>
{% endblock %}


