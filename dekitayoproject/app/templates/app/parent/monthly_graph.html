{# 保護者用　月間学習記録画面グラフ #}

{% extends 'app/parent/base.html' %}

{% load static %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/parent/monthly_graph.css' %}">
{% endblock %}

{% block content %}

{% if not child %}
    <p>お子さまを登録してください</p>
    <span class="period-title">{{ month }} 月のできた！</span>
{% else %}
    <p class="child-name">{{ child.user.username }}</p>
<div class="period-header">
    <a href="{% url 'parent_monthly_graph_by_month' prev_year prev_month %}" class="arrow">←</a>
    <span class="period-title">{{ month }} 月のできた！</span>
    <a href="{% url 'parent_monthly_graph_by_month' next_year next_month %}" class="arrow">→</a>
</div>
{% endif %}
<div class="period-title">合計できた数：{{ monthly_total }}個</div>

        
    <div class="content-box chart-box">
        <div class="chart-wrap">
                <canvas id="monthlyBar"></canvas>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> {# グラフライブラリ #}
    
    <script>
    const canvas = document.getElementById('monthlyBar'); // <canvas> を指定
    const rawLabels = {{ labels|safe }};

    const h = Math.max(260, rawLabels.length * 36);
    document.querySelector('.chart-wrap').style.height = `${h}px`;
    canvas.height = h;

    function labelWithEllipsis(text, perLine = 5, maxLines = 2) {
        if (text.length <= perLine) return text;

        const lines = [];
        for (let i = 0; i < text.length; i += perLine) {
            lines.push(text.slice(i, i + perLine));
        }

        if (lines.length <= maxLines) {
            return lines;
        }
        lines[maxLines - 1] =
            lines[maxLines - 1].slice(0, perLine - 1) + '…';

        return lines.slice(0, maxLines);
    }

    const labels2lineEllipsis = rawLabels.map(l =>
        labelWithEllipsis(l, 5, 2)
    );

    new Chart(canvas, {
        type: 'bar',  // 横棒グラフ
        data: {
            labels: labels2lineEllipsis,  //　学習項目名
            datasets: [{
            data: {{ counts|safe }},  // 横の長さ
            backgroundColor: {{ colors|safe }}, //　棒グラフの色（7色）
            }]
        },
        options: {
            indexAxis: 'y',   //  横棒にする際に必要（無いと縦棒になる）
            responsive: true,
            maintainAspectRatio: false, 

            scales: {
                x: {
                    beginAtZero: true, // メモリ設定　0から
                    ticks: {
                        stepSize: 1, // 1目盛りずつ
                        color: '#000' 
                    },
                    grid: {
                        color: '#ccc'   // ← 補助線（薄いグレーで上品）
                    }
                },
                y: {
                    ticks: {
                        color: '#000',  // ← 項目名（文字）を黒に
                        autoSkip: false
                    },
                    grid: {
                        display: false  // ← 横棒グラフなら消すと見やすい
                    }
                }
            },
            plugins: {
                legend: { display: false }, // 凡例は消す
                title: {
                    display: false
                }
            }
        }
    }); 
    </script>

{% endblock %}