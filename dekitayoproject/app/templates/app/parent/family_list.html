{# 保護者用　家族一覧 #}

{% extends 'app/parent/base.html' %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/parent/family_list.css' %}">
{% endblock %}

{# 削除確認用モーダル　JavaScript#}
{% block extra_js %}
<script>
// HTMLが全部読み込まれたらモーダル処理
document.addEventListener("DOMContentLoaded", () => {
    // 削除確認モーダル本体
    const deleteModal = document.getElementById("delete-modal");
    // 削除ボタン    
    const openBtn = document.getElementById("open-delete-modal");
    // キャンセルボタン
    const cancelBtn = document.getElementById("close-delete");
    // 自分自身を削除しようとしたとき、
    // サーバー側でエラーメッセージを出すために削除フォームを取得
    const deleteForm = document.getElementById("delete-form");

    // 家族が選択されているか確認　
    function isMemberSelected() {
        return document.querySelector('input[name="user_id"]:checked');
    }

    // 選択されたradiodのidを返す（未選択ならnull）
    function getSelectedRadio() {
        return document.querySelector('input[name="user_id"]:checked');
    }

    // 選択されていればモーダル表示
    function openDeleteModal() {
        const selected = getSelectedRadio();
        if (!selected) return;

    // ★自分のID（HTMLのdata-meから取得）
        const myId = deleteForm.dataset.me;

    // ★自分を選んでいたら：確認モーダルは出さない → サーバに送って messages を出す
        if (selected.value === myId) {
        deleteForm.submit();   // POST → ビューの「自分自身は削除できません」が messages で出る
        return;
        }

        // 本人以外なら：いつも通り確認モーダル
        deleteModal.classList.remove("hidden");
    }
    // モーダルを閉じる
    function closeDeleteModal() {
        deleteModal.classList.add("hidden");
    }
   // 削除ボタンがクリック→openDeleteModal（モーダルを開く）
   // キャンセルボタンがクリック→closeDeleteModal(モーダルを閉じる)
  if (openBtn && cancelBtn && deleteModal) {
    openBtn.addEventListener("click", openDeleteModal);
    cancelBtn.addEventListener("click", closeDeleteModal);
  }
});
</script>
{% endblock %}

{% block content %}

<h2 class="page-title">家族アカウント一覧</h2>

<form method="post" id="delete-form" data-me="{{ request.user.id }}">
{% csrf_token %}
<div class="list-box">
    {% for member in members %}
        <div class="member-row">
            <label class="member-box">

                <input
                type="radio"
                name="user_id"
                value="{{ member.id }}"
                >

                <span class="avatar">
                <img
                    src="{% static member.icon.image_url %}"
                    alt="member_icon"
                    class="member-icon"
                >
                </span>

                <span class="member-name">
                {{ member.username }}
                </span>


            </label>
        </div>
        {% empty %}
            <p class="empty">（家族メンバーがいません）</p>
        {% endfor %}
        </div>
        <button type="button" class=" btn btn-danger" id="open-delete-modal">削除</button>
</form>


{# 削除確認用モーダル HTML#}
<div id="delete-modal" class="modal-overlay hidden">
    <div class="modal">
        <p>削除しますか？</p>
        <div class="modal-actions">
            <button type="submit" form="delete-form" class="btn yes">削除</button>
            <button type="button" class="btn no" id="close-delete">キャンセル</button>
        </div>
    </div>
</div>

{% endblock %}


